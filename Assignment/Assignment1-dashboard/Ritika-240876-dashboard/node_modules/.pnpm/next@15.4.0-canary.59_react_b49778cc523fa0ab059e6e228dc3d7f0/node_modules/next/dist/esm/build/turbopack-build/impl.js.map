{"version":3,"sources":["../../../src/build/turbopack-build/impl.ts"],"sourcesContent":["import path from 'path'\nimport { validateTurboNextConfig } from '../../lib/turbopack-warning'\nimport {\n  formatIssue,\n  getTurbopackJsConfig,\n  isPersistentCachingEnabled,\n  isRelevantWarning,\n} from '../../shared/lib/turbopack/utils'\nimport { NextBuildContext } from '../build-context'\nimport { createDefineEnv, loadBindings } from '../swc'\nimport {\n  rawEntrypointsToEntrypoints,\n  handleRouteType,\n} from '../handle-entrypoints'\nimport { TurbopackManifestLoader } from '../../shared/lib/turbopack/manifest-loader'\nimport { promises as fs } from 'fs'\nimport { PHASE_PRODUCTION_BUILD } from '../../shared/lib/constants'\nimport loadConfig from '../../server/config'\nimport { hasCustomExportOutput } from '../../export/utils'\nimport { Telemetry } from '../../telemetry/storage'\nimport { setGlobal } from '../../trace'\nimport * as Log from '../output/log'\nimport { isCI } from '../../server/ci-info'\n\nexport async function turbopackBuild(): Promise<{\n  duration: number\n  buildTraceContext: undefined\n  shutdownPromise: Promise<void>\n}> {\n  await validateTurboNextConfig({\n    dir: NextBuildContext.dir!,\n    isDev: false,\n  })\n\n  const config = NextBuildContext.config!\n  const dir = NextBuildContext.dir!\n  const distDir = NextBuildContext.distDir!\n  const buildId = NextBuildContext.buildId!\n  const encryptionKey = NextBuildContext.encryptionKey!\n  const previewProps = NextBuildContext.previewProps!\n  const hasRewrites = NextBuildContext.hasRewrites!\n  const rewrites = NextBuildContext.rewrites!\n  const appDirOnly = NextBuildContext.appDirOnly!\n  const noMangling = NextBuildContext.noMangling!\n\n  const startTime = process.hrtime()\n  const bindings = await loadBindings(config?.experimental?.useWasmBinary)\n  const dev = false\n\n  // const supportedBrowsers = await getSupportedBrowsers(dir, dev)\n  const supportedBrowsers = [\n    'last 1 Chrome versions, last 1 Firefox versions, last 1 Safari versions, last 1 Edge versions',\n  ]\n\n  const persistentCaching = isPersistentCachingEnabled(config)\n  const project = await bindings.turbo.createProject(\n    {\n      projectPath: dir,\n      rootPath: config.turbopack?.root || config.outputFileTracingRoot || dir,\n      distDir,\n      nextConfig: config,\n      jsConfig: await getTurbopackJsConfig(dir, config),\n      watch: {\n        enable: false,\n      },\n      dev,\n      env: process.env as Record<string, string>,\n      defineEnv: createDefineEnv({\n        isTurbopack: true,\n        clientRouterFilters: NextBuildContext.clientRouterFilters!,\n        config,\n        dev,\n        distDir,\n        projectPath: dir,\n        fetchCacheKeyPrefix: config.experimental.fetchCacheKeyPrefix,\n        hasRewrites,\n        // Implemented separately in Turbopack, doesn't have to be passed here.\n        middlewareMatchers: undefined,\n      }),\n      buildId,\n      encryptionKey,\n      previewProps,\n      browserslistQuery: supportedBrowsers.join(', '),\n      noMangling,\n    },\n    {\n      persistentCaching,\n      memoryLimit: config.experimental?.turbopackMemoryLimit,\n      dependencyTracking: persistentCaching,\n      isCi: isCI,\n    }\n  )\n  try {\n    ;(async function logCompilationEvents() {\n      for await (const event of project.compilationEventsSubscribe()) {\n        switch (event.severity) {\n          case 'EVENT':\n            Log.event(event.message)\n            break\n          case 'TRACE':\n            Log.trace(event.message)\n            break\n          case 'INFO':\n            Log.info(event.message)\n            break\n          case 'WARNING':\n            Log.warn(event.message)\n            break\n          case 'ERROR':\n            Log.error(event.message)\n            break\n          case 'FATAL':\n            Log.error(event.message)\n            break\n          default:\n            break\n        }\n      }\n    })()\n\n    // Write an empty file in a known location to signal this was built with Turbopack\n    await fs.writeFile(path.join(distDir, 'turbopack'), '')\n\n    await fs.mkdir(path.join(distDir, 'server'), { recursive: true })\n    await fs.mkdir(path.join(distDir, 'static', buildId), {\n      recursive: true,\n    })\n    await fs.writeFile(\n      path.join(distDir, 'package.json'),\n      JSON.stringify(\n        {\n          type: 'commonjs',\n        },\n        null,\n        2\n      )\n    )\n\n    // eslint-disable-next-line @typescript-eslint/no-unused-vars\n    const entrypoints = await project.writeAllEntrypointsToDisk(appDirOnly)\n\n    const manifestLoader = new TurbopackManifestLoader({\n      buildId,\n      distDir,\n      encryptionKey,\n    })\n\n    const topLevelErrors = []\n    const topLevelWarnings = []\n    for (const issue of entrypoints.issues) {\n      if (issue.severity === 'error' || issue.severity === 'fatal') {\n        topLevelErrors.push(formatIssue(issue))\n      } else if (isRelevantWarning(issue)) {\n        topLevelWarnings.push(formatIssue(issue))\n      }\n    }\n\n    if (topLevelWarnings.length > 0) {\n      console.warn(\n        `Turbopack build encountered ${\n          topLevelWarnings.length\n        } warnings:\\n${topLevelWarnings.join('\\n')}`\n      )\n    }\n\n    if (topLevelErrors.length > 0) {\n      throw new Error(\n        `Turbopack build failed with ${\n          topLevelErrors.length\n        } errors:\\n${topLevelErrors.join('\\n')}`\n      )\n    }\n\n    const currentEntrypoints = await rawEntrypointsToEntrypoints(entrypoints)\n\n    const promises: Promise<any>[] = []\n\n    if (!appDirOnly) {\n      for (const [page, route] of currentEntrypoints.page) {\n        promises.push(\n          handleRouteType({\n            page,\n            route,\n            manifestLoader,\n          })\n        )\n      }\n    }\n\n    for (const [page, route] of currentEntrypoints.app) {\n      promises.push(\n        handleRouteType({\n          page,\n          route,\n          manifestLoader,\n        })\n      )\n    }\n\n    await Promise.all(promises)\n\n    await Promise.all([\n      manifestLoader.loadBuildManifest('_app'),\n      manifestLoader.loadPagesManifest('_app'),\n      manifestLoader.loadFontManifest('_app'),\n      manifestLoader.loadPagesManifest('_document'),\n      manifestLoader.loadBuildManifest('_error'),\n      manifestLoader.loadPagesManifest('_error'),\n      manifestLoader.loadFontManifest('_error'),\n      entrypoints.instrumentation &&\n        manifestLoader.loadMiddlewareManifest(\n          'instrumentation',\n          'instrumentation'\n        ),\n      entrypoints.middleware &&\n        (await manifestLoader.loadMiddlewareManifest(\n          'middleware',\n          'middleware'\n        )),\n    ])\n\n    await manifestLoader.writeManifests({\n      devRewrites: undefined,\n      productionRewrites: rewrites,\n      entrypoints: currentEntrypoints,\n    })\n\n    const shutdownPromise = project.shutdown()\n\n    const time = process.hrtime(startTime)\n    return {\n      duration: time[0] + time[1] / 1e9,\n      buildTraceContext: undefined,\n      shutdownPromise,\n    }\n  } catch (err) {\n    await project.shutdown()\n    throw err\n  }\n}\n\nlet shutdownPromise: Promise<void> | undefined\nexport async function workerMain(workerData: {\n  buildContext: typeof NextBuildContext\n}): Promise<Awaited<ReturnType<typeof turbopackBuild>>> {\n  // setup new build context from the serialized data passed from the parent\n  Object.assign(NextBuildContext, workerData.buildContext)\n\n  /// load the config because it's not serializable\n  NextBuildContext.config = await loadConfig(\n    PHASE_PRODUCTION_BUILD,\n    NextBuildContext.dir!\n  )\n\n  // Matches handling in build/index.ts\n  // https://github.com/vercel/next.js/blob/84f347fc86f4efc4ec9f13615c215e4b9fb6f8f0/packages/next/src/build/index.ts#L815-L818\n  // Ensures the `config.distDir` option is matched.\n  if (hasCustomExportOutput(NextBuildContext.config)) {\n    NextBuildContext.config.distDir = '.next'\n  }\n\n  // Clone the telemetry for worker\n  const telemetry = new Telemetry({\n    distDir: NextBuildContext.config.distDir,\n  })\n  setGlobal('telemetry', telemetry)\n\n  const result = await turbopackBuild()\n  shutdownPromise = result.shutdownPromise\n  return result\n}\n\nexport async function waitForShutdown(): Promise<void> {\n  if (shutdownPromise) {\n    await shutdownPromise\n  }\n}\n"],"names":["path","validateTurboNextConfig","formatIssue","getTurbopackJsConfig","isPersistentCachingEnabled","isRelevantWarning","NextBuildContext","createDefineEnv","loadBindings","rawEntrypointsToEntrypoints","handleRouteType","TurbopackManifestLoader","promises","fs","PHASE_PRODUCTION_BUILD","loadConfig","hasCustomExportOutput","Telemetry","setGlobal","Log","isCI","turbopackBuild","config","dir","isDev","distDir","buildId","encryptionKey","previewProps","hasRewrites","rewrites","appDirOnly","noMangling","startTime","process","hrtime","bindings","experimental","useWasmBinary","dev","supportedBrowsers","persistentCaching","project","turbo","createProject","projectPath","rootPath","turbopack","root","outputFileTracingRoot","nextConfig","jsConfig","watch","enable","env","defineEnv","isTurbopack","clientRouterFilters","fetchCacheKeyPrefix","middlewareMatchers","undefined","browserslistQuery","join","memoryLimit","turbopackMemoryLimit","dependencyTracking","isCi","logCompilationEvents","event","compilationEventsSubscribe","severity","message","trace","info","warn","error","writeFile","mkdir","recursive","JSON","stringify","type","entrypoints","writeAllEntrypointsToDisk","manifestLoader","topLevelErrors","topLevelWarnings","issue","issues","push","length","console","Error","currentEntrypoints","page","route","app","Promise","all","loadBuildManifest","loadPagesManifest","loadFontManifest","instrumentation","loadMiddlewareManifest","middleware","writeManifests","devRewrites","productionRewrites","shutdownPromise","shutdown","time","duration","buildTraceContext","err","workerMain","workerData","Object","assign","buildContext","telemetry","result","waitForShutdown"],"mappings":"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","ignoreList":[0]}