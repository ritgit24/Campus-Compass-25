{"version":3,"sources":["../../../src/server/route-modules/route-module.ts"],"sourcesContent":["import type { IncomingMessage, ServerResponse } from 'node:http'\nimport type { InstrumentationOnRequestError } from '../instrumentation/types'\nimport type { ParsedUrlQuery } from 'node:querystring'\nimport type { UrlWithParsedQuery } from 'node:url'\nimport type {\n  PrerenderManifest,\n  RequiredServerFilesManifest,\n} from '../../build'\nimport type { DevRoutesManifest } from '../lib/router-utils/setup-dev-bundler'\nimport type { RouteDefinition } from '../route-definitions/route-definition'\nimport type { DeepReadonly } from '../../shared/lib/deep-readonly'\n\nimport {\n  BUILD_ID_FILE,\n  BUILD_MANIFEST,\n  NEXT_FONT_MANIFEST,\n  PRERENDER_MANIFEST,\n  REACT_LOADABLE_MANIFEST,\n  ROUTES_MANIFEST,\n  SERVER_FILES_MANIFEST,\n} from '../../shared/lib/constants'\nimport { parseReqUrl } from '../../lib/url'\nimport {\n  normalizeLocalePath,\n  type PathLocale,\n} from '../../shared/lib/i18n/normalize-locale-path'\nimport { isDynamicRoute } from '../../shared/lib/router/utils'\nimport { removePathPrefix } from '../../shared/lib/router/utils/remove-path-prefix'\nimport { getServerUtils } from '../server-utils'\nimport { detectDomainLocale } from '../../shared/lib/i18n/detect-domain-locale'\nimport { getHostname } from '../../shared/lib/get-hostname'\nimport { checkIsOnDemandRevalidate } from '../api-utils'\nimport type { PreviewData } from '../../types'\nimport type { BuildManifest } from '../get-page-files'\nimport type { ReactLoadableManifest } from '../load-components'\nimport type { NextFontManifest } from '../../build/webpack/plugins/next-font-manifest-plugin'\nimport { normalizeDataPath } from '../../shared/lib/page-path/normalize-data-path'\nimport { pathHasPrefix } from '../../shared/lib/router/utils/path-has-prefix'\nimport { addRequestMeta, getRequestMeta } from '../request-meta'\nimport { normalizePagePath } from '../../shared/lib/page-path/normalize-page-path'\n\n/**\n * RouteModuleOptions is the options that are passed to the route module, other\n * route modules should extend this class to add specific options for their\n * route.\n */\nexport interface RouteModuleOptions<\n  D extends RouteDefinition = RouteDefinition,\n  U = unknown,\n> {\n  readonly definition: Readonly<D>\n  readonly userland: Readonly<U>\n  readonly distDir: string\n  readonly projectDir: string\n}\n\n/**\n * RouteHandlerContext is the base context for a route handler.\n */\nexport interface RouteModuleHandleContext {\n  /**\n   * Any matched parameters for the request. This is only defined for dynamic\n   * routes.\n   */\n  params: Record<string, string | string[] | undefined> | undefined\n}\n\n/**\n * RouteModule is the base class for all route modules. This class should be\n * extended by all route modules.\n */\nexport abstract class RouteModule<\n  D extends RouteDefinition = RouteDefinition,\n  U = unknown,\n> {\n  /**\n   * The userland module. This is the module that is exported from the user's\n   * code. This is marked as readonly to ensure that the module is not mutated\n   * because the module (when compiled) only provides getters.\n   */\n  public readonly userland: Readonly<U>\n\n  /**\n   * The definition of the route.\n   */\n  public readonly definition: Readonly<D>\n\n  /**\n   * The shared modules that are exposed and required for the route module.\n   */\n  public static readonly sharedModules: any\n\n  public isDev: boolean\n  public distDir: string\n  public projectDir: string\n\n  constructor({\n    userland,\n    definition,\n    distDir,\n    projectDir,\n  }: RouteModuleOptions<D, U>) {\n    this.userland = userland\n    this.definition = definition\n    this.isDev = process.env.NODE_ENV === 'development'\n    this.distDir = distDir\n    this.projectDir = projectDir\n  }\n\n  public async instrumentationOnRequestError(\n    req: IncomingMessage,\n    ...args: Parameters<InstrumentationOnRequestError>\n  ) {\n    // this is only handled here for node, for edge it\n    // is handled in the adapter/loader instead\n    if (process.env.NEXT_RUNTIME !== 'edge') {\n      const { join } = require('node:path')\n      const projectDir =\n        getRequestMeta(req, 'projectDir') ||\n        join(process.cwd(), this.projectDir)\n\n      const { instrumentationOnRequestError } = await import(\n        '../lib/router-utils/instrumentation-globals.external'\n      )\n\n      return instrumentationOnRequestError(projectDir, this.distDir, ...args)\n    }\n  }\n\n  private async loadManifests(projectDir: string, srcPage: string) {\n    if (process.env.NEXT_RUNTIME !== 'edge') {\n      const { loadManifestFromRelativePath } = await import(\n        '../load-manifest.external'\n      )\n      const normalizedPagePath = normalizePagePath(srcPage)\n\n      const [\n        routesManifest,\n        prerenderManifest,\n        buildManifest,\n        reactLoadableManifest,\n        nextFontManifest,\n        serverFilesManifest,\n        buildId,\n      ] = await Promise.all([\n        loadManifestFromRelativePath<DevRoutesManifest>({\n          projectDir,\n          distDir: this.distDir,\n          manifest: ROUTES_MANIFEST,\n        }),\n        loadManifestFromRelativePath<PrerenderManifest>({\n          projectDir,\n          distDir: this.distDir,\n          manifest: PRERENDER_MANIFEST,\n        }),\n        loadManifestFromRelativePath<BuildManifest>({\n          projectDir,\n          distDir: this.distDir,\n          manifest: BUILD_MANIFEST,\n        }),\n        loadManifestFromRelativePath<ReactLoadableManifest>({\n          projectDir,\n          distDir: this.distDir,\n          manifest: process.env.TURBOPACK\n            ? `server/pages${normalizedPagePath}/${REACT_LOADABLE_MANIFEST}`\n            : REACT_LOADABLE_MANIFEST,\n          handleMissing: true,\n        }),\n        loadManifestFromRelativePath<NextFontManifest>({\n          projectDir,\n          distDir: this.distDir,\n          manifest: `server/${NEXT_FONT_MANIFEST}.json`,\n        }),\n        this.isDev\n          ? ({} as any)\n          : loadManifestFromRelativePath<RequiredServerFilesManifest>({\n              projectDir,\n              distDir: this.distDir,\n              manifest: SERVER_FILES_MANIFEST,\n            }),\n        this.isDev\n          ? 'development'\n          : loadManifestFromRelativePath<any>({\n              projectDir,\n              distDir: this.distDir,\n              manifest: BUILD_ID_FILE,\n              skipParse: true,\n            }),\n      ])\n\n      return {\n        buildId,\n        buildManifest,\n        routesManifest,\n        nextFontManifest,\n        prerenderManifest,\n        serverFilesManifest,\n        reactLoadableManifest,\n      }\n    }\n    throw new Error('Invariant: loadManifests called for edge runtime')\n  }\n\n  public async prepare(\n    req: IncomingMessage,\n    res: ServerResponse,\n    {\n      srcPage,\n      multiZoneDraftMode,\n    }: {\n      srcPage: string\n      multiZoneDraftMode?: boolean\n    }\n  ): Promise<\n    | {\n        buildId: string\n        locale?: string\n        locales?: readonly string[]\n        defaultLocale?: string\n        query: ParsedUrlQuery\n        originalQuery: ParsedUrlQuery\n        originalPathname: string\n        params?: ParsedUrlQuery\n        parsedUrl: UrlWithParsedQuery\n        previewData: PreviewData\n        isDraftMode: boolean\n        isNextDataRequest: boolean\n        buildManifest: DeepReadonly<BuildManifest>\n        nextFontManifest: DeepReadonly<NextFontManifest>\n        serverFilesManifest: DeepReadonly<RequiredServerFilesManifest>\n        reactLoadableManifest: DeepReadonly<ReactLoadableManifest>\n        routesManifest: DeepReadonly<DevRoutesManifest>\n        prerenderManifest: DeepReadonly<PrerenderManifest>\n        isOnDemandRevalidate: boolean\n        revalidateOnlyGenerated: boolean\n      }\n    | undefined\n  > {\n    // \"prepare\" is only needed for node runtime currently\n    // if we want to share the normalizing logic here\n    // we will need to allow passing in the i18n and similar info\n    if (process.env.NEXT_RUNTIME !== 'edge') {\n      const { join } = require('node:path')\n      const projectDir =\n        getRequestMeta(req, 'projectDir') ||\n        join(process.cwd(), this.projectDir)\n\n      const { ensureInstrumentationRegistered } = await import(\n        '../lib/router-utils/instrumentation-globals.external'\n      )\n      // ensure instrumentation is registered and pass\n      // onRequestError below\n      ensureInstrumentationRegistered(projectDir, this.distDir)\n\n      const manifests = await this.loadManifests(projectDir, srcPage)\n      const { routesManifest, prerenderManifest } = manifests\n      const { basePath, i18n, rewrites } = routesManifest\n\n      if (basePath) {\n        req.url = removePathPrefix(req.url || '/', basePath)\n      }\n\n      const parsedUrl = parseReqUrl(req.url || '/')\n      // if we couldn't parse the URL we can't continue\n      if (!parsedUrl) {\n        return\n      }\n      let isNextDataRequest = false\n\n      if (pathHasPrefix(parsedUrl.pathname || '/', '/_next/data')) {\n        isNextDataRequest = true\n        parsedUrl.pathname = normalizeDataPath(parsedUrl.pathname || '/')\n      }\n      let originalPathname = parsedUrl.pathname || '/'\n      const originalQuery = { ...parsedUrl.query }\n      const pageIsDynamic = isDynamicRoute(srcPage)\n\n      let localeResult: PathLocale | undefined\n      let detectedLocale: string | undefined\n\n      if (i18n) {\n        localeResult = normalizeLocalePath(\n          parsedUrl.pathname || '/',\n          i18n.locales\n        )\n\n        if (localeResult.detectedLocale) {\n          req.url = `${localeResult.pathname}${parsedUrl.search}`\n          originalPathname = localeResult.pathname\n\n          if (!detectedLocale) {\n            detectedLocale = localeResult.detectedLocale\n          }\n        }\n      }\n\n      const serverUtils = getServerUtils({\n        page: srcPage,\n        i18n,\n        basePath,\n        rewrites,\n        pageIsDynamic,\n        trailingSlash: process.env.__NEXT_TRAILING_SLASH as any as boolean,\n        caseSensitive: Boolean(routesManifest.caseSensitive),\n      })\n\n      const domainLocale = detectDomainLocale(\n        i18n?.domains,\n        getHostname(parsedUrl, req.headers),\n        detectedLocale\n      )\n      addRequestMeta(req, 'isLocaleDomain', Boolean(domainLocale))\n\n      const defaultLocale = domainLocale?.defaultLocale || i18n?.defaultLocale\n\n      // Ensure parsedUrl.pathname includes locale before processing\n      // rewrites or they won't match correctly.\n      if (defaultLocale && !detectedLocale) {\n        parsedUrl.pathname = `/${defaultLocale}${parsedUrl.pathname}`\n      }\n      const locale =\n        getRequestMeta(req, 'locale') || detectedLocale || defaultLocale\n\n      const rewriteParamKeys = Object.keys(\n        serverUtils.handleRewrites(req, parsedUrl)\n      )\n\n      // after processing rewrites we want to remove locale\n      // from parsedUrl pathname\n      if (i18n) {\n        parsedUrl.pathname = normalizeLocalePath(\n          parsedUrl.pathname || '/',\n          i18n.locales\n        ).pathname\n      }\n\n      let params: Record<string, undefined | string | string[]> | undefined =\n        getRequestMeta(req, 'params')\n\n      // attempt parsing from pathname\n      if (!params && serverUtils.dynamicRouteMatcher) {\n        const paramsResult = serverUtils.dynamicRouteMatcher(\n          normalizeDataPath(localeResult?.pathname || parsedUrl.pathname || '/')\n        )\n        if (paramsResult) {\n          params = paramsResult\n        }\n      }\n\n      // Local \"next start\" expects the routing parsed query values\n      // to not be present in the URL although when deployed proxies\n      // will add query values from resolving the routes to pass to function.\n\n      // TODO: do we want to change expectations for \"next start\"\n      // to include these query values in the URL which affects asPath\n      // but would match deployed behavior, e.g. a rewrite from middleware\n      // that adds a query param would be in asPath as query but locally\n      // it won't be in the asPath but still available in the query object\n      const query = getRequestMeta(req, 'query') || {\n        ...parsedUrl.query,\n      }\n\n      const routeParamKeys = new Set<string>()\n      const combinedParamKeys = [...rewriteParamKeys, ...routeParamKeys]\n\n      serverUtils.normalizeCdnUrl(req, combinedParamKeys)\n      serverUtils.normalizeQueryParams(query, routeParamKeys)\n      serverUtils.filterInternalQuery(originalQuery, combinedParamKeys)\n\n      if (pageIsDynamic) {\n        const result = serverUtils.normalizeDynamicRouteParams(query, true)\n\n        req.url = serverUtils.interpolateDynamicPath(\n          req.url || '/',\n          params || query\n        )\n        parsedUrl.pathname = serverUtils.interpolateDynamicPath(\n          parsedUrl.pathname || '/',\n          params || query\n        )\n        originalPathname = serverUtils.interpolateDynamicPath(\n          originalPathname,\n          params || query\n        )\n\n        // try pulling from query if valid\n        if (result.hasValidParams) {\n          params = Object.assign({}, result.params, params)\n\n          // If we pulled from query remove it so it's\n          // only in params\n          for (const key in params) {\n            delete query[key]\n          }\n        }\n      }\n\n      // Remove any normalized params from the query if they\n      // weren't present as non-prefixed query key e.g.\n      // ?search=1&nxtPsearch=hello we don't delete search\n      for (const key of routeParamKeys) {\n        if (!(key in originalQuery)) {\n          delete query[key]\n        }\n      }\n\n      const { isOnDemandRevalidate, revalidateOnlyGenerated } =\n        checkIsOnDemandRevalidate(req, prerenderManifest.preview)\n\n      let isDraftMode = false\n      let previewData: PreviewData\n\n      const { tryGetPreviewData } =\n        require('../api-utils/node/try-get-preview-data') as typeof import('../api-utils/node/try-get-preview-data')\n\n      previewData = tryGetPreviewData(\n        req,\n        res,\n        prerenderManifest.preview,\n        Boolean(multiZoneDraftMode)\n      )\n      isDraftMode = previewData !== false\n\n      return {\n        query,\n        originalQuery,\n        originalPathname,\n        params,\n        parsedUrl,\n        locale,\n        isNextDataRequest,\n        locales: i18n?.locales,\n        defaultLocale,\n        isDraftMode,\n        previewData,\n        isOnDemandRevalidate,\n        revalidateOnlyGenerated,\n        ...manifests,\n      }\n    }\n  }\n}\n"],"names":["BUILD_ID_FILE","BUILD_MANIFEST","NEXT_FONT_MANIFEST","PRERENDER_MANIFEST","REACT_LOADABLE_MANIFEST","ROUTES_MANIFEST","SERVER_FILES_MANIFEST","parseReqUrl","normalizeLocalePath","isDynamicRoute","removePathPrefix","getServerUtils","detectDomainLocale","getHostname","checkIsOnDemandRevalidate","normalizeDataPath","pathHasPrefix","addRequestMeta","getRequestMeta","normalizePagePath","RouteModule","constructor","userland","definition","distDir","projectDir","isDev","process","env","NODE_ENV","instrumentationOnRequestError","req","args","NEXT_RUNTIME","join","require","cwd","loadManifests","srcPage","loadManifestFromRelativePath","normalizedPagePath","routesManifest","prerenderManifest","buildManifest","reactLoadableManifest","nextFontManifest","serverFilesManifest","buildId","Promise","all","manifest","TURBOPACK","handleMissing","skipParse","Error","prepare","res","multiZoneDraftMode","ensureInstrumentationRegistered","manifests","basePath","i18n","rewrites","url","parsedUrl","isNextDataRequest","pathname","originalPathname","originalQuery","query","pageIsDynamic","localeResult","detectedLocale","locales","search","serverUtils","page","trailingSlash","__NEXT_TRAILING_SLASH","caseSensitive","Boolean","domainLocale","domains","headers","defaultLocale","locale","rewriteParamKeys","Object","keys","handleRewrites","params","dynamicRouteMatcher","paramsResult","routeParamKeys","Set","combinedParamKeys","normalizeCdnUrl","normalizeQueryParams","filterInternalQuery","result","normalizeDynamicRouteParams","interpolateDynamicPath","hasValidParams","assign","key","isOnDemandRevalidate","revalidateOnlyGenerated","preview","isDraftMode","previewData","tryGetPreviewData"],"mappings":"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","ignoreList":[0]}